FROM registry.docker/secondlife/gobuild:1.11 AS builder

WORKDIR /src
COPY . .

RUN go build -mod=readonly . && \
    go test ./... -cover && \
    go install


FROM registry.docker/secondlife/debuild:buster AS packager

COPY . .
COPY --from=builder /go/bin/get-secret .

RUN mk-build-deps -i -t 'apt-get -y --no-install-recommends' -r debian/control && \
    debuild -uc -us -b -I.git && \
    # outside the /build volume, so it's in the built layer
    mkdir /packages && \
    mv /build/*.deb /packages

